<!DOCTYPE html>
<html>
<head>
    <title>Classe</title>

    <!-- Meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Pagina con il link al materiale scolastico">
    <meta name="author" content="Francesco Belloni">
    <link rel="shortcut icon" href="favicon.ico">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

    <script>// Global variables
        let my_grade = "";
        let my_year = "2022";
        let my_subject = "Informatica";
        var url_json_database_folder = "https://francobelloni85.github.io/francobelloni85/data/"
        var json_lesson_response = {};
        var status_fetch = false;</script>


    <style>
        .cls-1 {
            fill: none;
            stroke: #ffffff;
            stroke-miterlimit: 10;
            stroke-width: 1.92px;
        }

        .width-100-p {
            width: 100%;
        }

        .card {
            margin-top: 10px;
        }

        .btn-link {
            
        }

        .avatar-image {
            height: 50px;
        }

        .b-example-divider {
            width: 100%;
            height: 3rem;
            background-color: rgba(0, 0, 0, .1);
            border: solid rgba(0, 0, 0, .15);
            border-top-width: medium;
            border-right-width: medium;
            border-bottom-width: medium;
            border-left-width: medium;
            border-width: 1px 0;
            box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
        }
    </style>

    <style>
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .match-date {
            flex: 1;
            text-align: left;
            color: #808080;
        }

        .match-players {
            flex: 2;
            text-align: left;
            font-weight: bold;
            font-size: 22px;
            color: #000000;
        }
    </style>

</head>
<body>

    <div class="navbar navbar-dark bg-dark shadow-sm">
        <div class="container">
            <a href="../index.html" class="navbar-brand d-flex align-items-center">
                <svg width="20px" height="20px" viewBox="0 0 24 24" id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg">
                    <rect class="cls-1" x="3.38" y="3.38" width="17.25" height="17.25" rx="2.18" />
                    <rect class="cls-1" x="7.21" y="7.21" width="9.58" height="9.58" rx="1.92" />
                    <line class="cls-1" x1="7.21" y1="0.5" x2="7.21" y2="2.42" />
                    <line class="cls-1" x1="12" y1="0.5" x2="12" y2="2.42" />
                    <line class="cls-1" x1="16.79" y1="0.5" x2="16.79" y2="2.42" />
                    <line class="cls-1" x1="7.21" y1="21.58" x2="7.21" y2="23.5" />
                    <line class="cls-1" x1="12" y1="21.58" x2="12" y2="23.5" />
                    <line class="cls-1" x1="16.79" y1="21.58" x2="16.79" y2="23.5" />
                    <line class="cls-1" x1="0.5" y1="16.79" x2="2.42" y2="16.79" />
                    <line class="cls-1" x1="0.5" y1="12" x2="2.42" y2="12" />
                    <line class="cls-1" x1="0.5" y1="7.21" x2="2.42" y2="7.21" />
                    <line class="cls-1" x1="21.58" y1="16.79" x2="23.5" y2="16.79" />
                    <line class="cls-1" x1="21.58" y1="12" x2="23.5" y2="12" />
                    <line class="cls-1" x1="21.58" y1="7.21" x2="23.5" y2="7.21" />
                </svg>
                &nbsp;
                <strong>{Informatica}</strong>
            </a>
        </div>
    </div>

    <section class="py-5 text-center container">
        <div class="row py-lg-5">
            <div class="col-lg-6 col-md-8 mx-auto">
                <h1 class="fw-light">
                    Torneo
                    <span class="text-highlight pr-2">{</span>
                    <span id="grade_title" class="name">...</span>
                    <span class="text-highlight pl-2">}</span>
                </h1>
                <p class="lead text-body-secondary">
                    <span id="subject_title" class="desc d-block">...</span>
                </p>
            </div>
        </div>
    </section>

    <div class="album py-5 bg-body-tertiary">
        <div class="container">

            <h1>Studenti</h1>
            <br />
            <table id="studentTable" class="table">
                <thead>
                    <tr>
                        <th width="50px">ID</th>
                        <th>Avatar</th>
                        <th>Nome</th>
                        <th>Cognome</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <br /><br />

            <h1>Match</h1>
            <br />
            <div id="accordion"></div>

            <br /><br />

            <h1>Classifica</h1>
            <br />
            <table id="rankingTable" class="table">
                <thead>
                    <tr>
                        <th width="50px">ID</th>
                        <th>Avatar</th>
                        <th>Nome</th>
                        <th>Partite Fatte</th>
                        <th>Vittorie</th>
                        <th>Sconfitte</th>
                        <th>Pareggi</th>
                        <th>Punti</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>

            <br>
            <div class="text-center mt-5">
                <a class="btn btn-primary scrollto" href="../index.html">Indietro</a>
            </div>


        </div>
    </div>

    <script>

    function LoadStudentsTable(studentsData){

        var studentTable = document.getElementById("studentTable").getElementsByTagName('tbody')[0];

        studentsData.students.forEach(function(student) {
            var row = studentTable.insertRow();
            var idCell = row.insertCell(0);
            var avatarCell = row.insertCell(1);
            var nameCell = row.insertCell(2);
            var surnameCell = row.insertCell(3);

            idCell.innerHTML = student.Id;
            avatarCell.innerHTML = '<img class="avatar-image" src="../assets/images/avatar/' + student.Id + '.png" alt="Avatar">';
            nameCell.innerHTML = student.Name;
            surnameCell.innerHTML = student.Surname;
        });

        var studentStats = {};

        studentsData.students.forEach(function(student) {
            studentStats[student.Id] = {
                id: student.Id,
                name: student.Name + " " + student.Surname,
                avatar: '<img class="avatar-image" src="../assets/images/avatar/' + student.Id + '.png" alt="Avatar">',
                matchesPlayed: 0,
                wins: 0,
                losses: 0,
                draws: 0,
                points: 0
            };
        });

        studentsData.matchs.forEach(function(match) {
            studentStats[match.student1_id].matchesPlayed++;
            studentStats[match.student2_id].matchesPlayed++;

            if (match.winner === match.student1_id) {
                studentStats[match.student1_id].wins++;
                studentStats[match.student1_id].points += 3;
                studentStats[match.student2_id].losses++;
            } else if (match.winner === match.student2_id) {
                studentStats[match.student2_id].wins++;
                studentStats[match.student2_id].points += 3;
                studentStats[match.student1_id].losses++;
            } else {
                studentStats[match.student1_id].draws++;
                studentStats[match.student2_id].draws++;
                studentStats[match.student1_id].points++;
                studentStats[match.student2_id].points++;
            }
        });

        var sortedStudents = Object.values(studentStats).sort(function(a, b) {
            return b.points - a.points;
        });

        var rankingTable = document.getElementById("rankingTable").getElementsByTagName('tbody')[0];

        sortedStudents.forEach(function(student) {
            var row = rankingTable.insertRow();
            var idCell = row.insertCell(0);
            var avatarCell = row.insertCell(1);
            var nameCell = row.insertCell(2);
            var matchesPlayedCell = row.insertCell(3);
            var winsCell = row.insertCell(4);
            var lossesCell = row.insertCell(5);
            var drawsCell = row.insertCell(6);
            var pointsCell = row.insertCell(7);

            idCell.innerHTML = student.id;
            avatarCell.innerHTML = student.avatar;
            nameCell.innerHTML = student.name;
            matchesPlayedCell.innerHTML = student.matchesPlayed;
            winsCell.innerHTML = student.wins;
            lossesCell.innerHTML = student.losses;
            drawsCell.innerHTML = student.draws;
            pointsCell.innerHTML = student.points;
        });

    var accordion = document.getElementById("accordion");

        studentsData.matchs.forEach(function(match, index) {
        var student1 = studentsData.students.find(student => student.Id === match.student1_id);
        var student2 = studentsData.students.find(student => student.Id === match.student2_id);

        var card = document.createElement("div");
        card.classList.add("card");

        var cardHeader = document.createElement("div");
        cardHeader.classList.add("card-header");
        cardHeader.id = "heading" + index;

        var button = document.createElement("button");
        button.classList.add("btn", "btn-link", "d-flex", "width-100-p");
        button.setAttribute("data-toggle", "collapse");
        button.setAttribute("data-target", "#collapse" + index);
        button.setAttribute("aria-expanded", "true");
        button.setAttribute("aria-controls", "collapse" + index);
        //button.innerHTML = match.date + "  " + student1.Surname + " " + student1.Name + " vs " + student2.Surname + " " + student2.Name;

        var matchDate = document.createElement("div");
        matchDate.classList.add("match-date");
        matchDate.textContent = match.date;

        var matchPlayers = document.createElement("div");
        matchPlayers.classList.add("match-players");
        matchPlayers.textContent = student1.Surname + " " +  student1.Name + " vs " + student2.Surname + " " + student2.Name;

        button.appendChild(matchDate);
        button.appendChild(matchPlayers);

        cardHeader.appendChild(button);
        card.appendChild(cardHeader);

        var collapse = document.createElement("div");
        collapse.id = "collapse" + index;
        collapse.classList.add("collapse");
        collapse.setAttribute("aria-labelledby", "heading" + index);
        collapse.setAttribute("data-parent", "#accordion");

        var cardBody = document.createElement("div");
        cardBody.classList.add("card-body");

        var resultText = match.winner === 0 ? "Pareggio" : "Vittoria di: <b>" + (match.winner === match.student1_id ? student1.Name : student2.Name) + "</b>";
        cardBody.innerHTML = resultText + "<br>";
        cardBody.innerHTML += student1.Name + " " + student1.Surname + ": " + match.question1 + " (" + match.score_1 + " punti)<br>";
        cardBody.innerHTML += student2.Name + " " + student2.Surname + ": " + match.question2 + " (" + match.score_2 + " punti)";

        collapse.appendChild(cardBody);
        card.appendChild(collapse);

        accordion.appendChild(card);

        });
    }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.2/dist/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <!-- Javascript -->
    <script src="../assets/plugins/popper.min.js"></script>
    <script src="../assets/plugins/bootstrap/js/bootstrap.min.js"></script>
    <script src="../assets/js/main.js"></script>

    <script>$(document).ready(function () {

            // https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
            const params = new Proxy(new URLSearchParams(window.location.search), {
                get: (searchParams, prop) => searchParams.get(prop),
            });

            my_grade = params.grade;
            my_subject = params.subject;
            my_year = params.year;

            let file_name_lesson     = "tournament_" + my_grade + ".json"
            let url_file_name_lesson = url_json_database_folder + "/" + my_year + "/" + file_name_lesson;

            console.log("load url_file_name_lesson= " + url_file_name_lesson);

            const capitalized = my_subject.charAt(0).toUpperCase() + my_subject.slice(1);
            $('#grade_title').text(my_grade);
            $('#subject_title').text(capitalized);

            try {

                // console.log("loading resources with getJSON");

                $.getJSON(url_file_name_lesson, function (data, status) {
                    json_lesson_response = data;
                    status_fetch = status;
                    console.log("Object read is: ");
                    console.log(data);
                    LoadStudentsTable(data);
                });

            } catch (ex) {
                console.log(ex);
            }

        });

        function LoadLessionClick(index_lesson) {

            try {
                console.log("click on " + index_lesson);

                // Text
                var text_file_name = json_lesson_response.lessons[index_lesson].text;
                console.log("loading text " + text_file_name + "....");
                LoadLessonText(index_lesson, text_file_name);

                // Questions
                var question_file_name = json_lesson_response.lessons[index_lesson].questions;
                console.log("loading questions " + question_file_name + "....");
                LoadQuestions(index_lesson, question_file_name);


            } catch (ex) {
                console.log(ex);
            }
        }</script>

</body>
</html>
